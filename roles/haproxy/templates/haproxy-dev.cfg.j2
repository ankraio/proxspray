global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# HAProxy config for dev.ankra.dev


frontend http-in
    bind *:80
    # route infra subdomain and cloud domains to infra backend
    acl host_infra hdr_end(host) -i .infra.ankra.dev
    acl host_cloud hdr_end(host) -i .ankra.cloud
    use_backend infra-backend if host_infra or host_cloud

    # route dev subdomain to dev backend
    acl host_dev_sub hdr_end(host) -i .dev.ankra.dev
    use_backend dev-backend if host_dev_sub

    # custom domain ingress mappings
    {% if hostvars[inventory_hostname]['custom_domain_ingress'] is defined %}
    {% for entry in hostvars[inventory_hostname]['custom_domain_ingress'] %}
    acl host_{{ entry.host | replace('.', '_') }} hdr(host) -i {{ entry.host }}
    use_backend dev-backend if host_{{ entry.host | replace('.', '_') }}
    {% endfor %}
    {% endif %}

    default_backend dev-backend


backend dev-backend
{% for host in groups['development'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['http_port'] }} check
{% endfor %}

backend infra-backend
{% for host in groups['infrastructure'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['http_port'] | default('80') }} check
{% endfor %}



# TLS Passthrough frontend for HTTPS
frontend https-in
    bind *:443
    mode tcp
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }
    # route infra subdomain and cloud domains to infra backend
    acl sni_infra req.ssl_sni -i -m end .infra.ankra.dev
    acl sni_cloud req.ssl_sni -i -m end .ankra.cloud
    use_backend infra-backend-https if sni_infra or sni_cloud

    # route dev subdomain to dev backend
    acl sni_dev_sub req.ssl_sni -i -m end .dev.ankra.dev
    use_backend dev-backend-https if sni_dev_sub

    # custom domain ingress mappings (HTTPS)
    {% if hostvars[inventory_hostname]['custom_domain_ingress'] is defined %}
    {% for entry in hostvars[inventory_hostname]['custom_domain_ingress'] %}
    acl sni_{{ entry.host | replace('.', '_') }} req.ssl_sni -i -m end {{ entry.host }}
    use_backend dev-backend-https if sni_{{ entry.host | replace('.', '_') }}
    {% endfor %}
    {% endif %}

    default_backend dev-backend-https

# TLS Passthrough backends
backend dev-backend-https
    mode tcp
{% for host in groups['development'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['https_port'] }} check
{% endfor %}

backend infra-backend-https
    mode tcp
{% for host in groups['infrastructure'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['https_port'] | default('443') }} check
{% endfor %}

# NATS TCP passthrough frontend on port 4222
frontend nats-tcp-in
    bind *:4222
    mode tcp
    # inspect TLS ClientHello for SNI
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }
    # route based on custom nats_domain if defined
    {% if hostvars[inventory_hostname]['nats_domain'] is defined %}
    acl nats_sni req.ssl_sni -i {{ hostvars[inventory_hostname]['nats_domain'] }}
    use_backend nats-tcp-backend if nats_sni
    {% endif %}
    default_backend nats-tcp-backend

# NATS TCP backend for development (port 4222)
backend nats-tcp-backend
    mode tcp
{% for host in groups['development'] %}
    server {{ host }} {{ hostvars[host]['ansible_host'] }}:{{ hostvars[host]['nats_port'] }} check
{% endfor %}

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin
    stats show-legends
    stats show-node
    stats show-desc "HAProxy Dev Stats"
    stats admin if TRUE
